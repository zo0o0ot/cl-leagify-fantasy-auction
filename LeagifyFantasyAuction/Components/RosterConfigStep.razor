@using System.Net.Http.Json
@using LeagifyFantasyAuction.Models
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<div class="roster-config-step">
    <!-- Step Header -->
    <div class="step-header">
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
            <FluentLabel Typo="Typography.Subject">Configure Roster Positions</FluentLabel>
            <FluentLabel Style="color: #666;">
                Define the structure of fantasy teams for this auction. Use positions from your imported schools or create custom positions.
            </FluentLabel>
        </FluentStack>
    </div>

    <div class="step-body">
        @if (isLoading)
        {
            <div class="loading-section">
                <FluentProgressRing />
                <FluentLabel>Loading roster configuration...</FluentLabel>
            </div>
        }
        else
        {
            <div class="roster-config-container">
                
                <!-- Available Positions Context -->
                @if (availablePositions.Any())
                {
                    <FluentCard Style="padding: 20px; background-color: #e8f5e8; border: 1px solid #28a745; margin-bottom: 24px;">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                            <FluentLabel Weight="FontWeight.Bold" Style="color: #155724;">
                                Available Positions from Imported Schools
                            </FluentLabel>
                            <FluentStack Orientation="Orientation.Horizontal" Wrap="true" HorizontalGap="8">
                                @foreach (var position in availablePositions)
                                {
                                    <FluentBadge Fill="someValue" BackgroundColor="#28a745" Color="white" Style="margin: 2px;">
                                        @position
                                    </FluentBadge>
                                }
                            </FluentStack>
                            <FluentLabel Style="color: #666; font-size: 0.9em;">
                                These positions are available from your CSV import and can be used to create roster slots.
                            </FluentLabel>
                        </FluentStack>
                    </FluentCard>
                }

                <!-- Add New Position Section -->
                <FluentCard Style="background-color: #f8f9fa; border: 1px solid #dee2e6; margin-bottom: 24px;">
                    <div style="padding: 20px;">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                            <FluentLabel Weight="FontWeight.Bold">Add New Roster Position</FluentLabel>
                            
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="16" Wrap="true">
                                <div style="flex: 1; min-width: 250px;">
                                    @if (availablePositions.Any())
                                    {
                                        <FluentSelect @bind-Value="newPosition.PositionName"
                                                      Label="Position Name"
                                                      Items="@GetPositionOptions()"
                                                      OptionText="@(item => item)"
                                                      OptionValue="@(item => item)"
                                                      Required="true" />
                                        
                                        @if (newPosition.PositionName == "Custom")
                                        {
                                            <FluentTextField @bind-Value="newPosition.CustomPositionName" 
                                                             Label="Custom Position Name" 
                                                             Placeholder="Enter custom position name"
                                                             Style="margin-top: 8px;"
                                                             Required="true" />
                                        }
                                    }
                                    else
                                    {
                                        <FluentTextField @bind-Value="newPosition.PositionName" 
                                                         Label="Position Name" 
                                                         Placeholder="e.g., Power Conference, SEC, Flex"
                                                         Required="true" />
                                    }
                                </div>
                                
                                <div style="width: 140px;">
                                    <FluentNumberField @bind-Value="newPosition.SlotsPerTeam" 
                                                       Label="Slots per Team" 
                                                       Min="1" 
                                                       Max="10"
                                                       Required="true" />
                                </div>
                                
                                <div style="width: 120px;">
                                    <FluentLabel Style="margin-bottom: 4px;">Color</FluentLabel>
                                    <input type="color" @bind="newPosition.ColorCode" 
                                           style="width: 100%; height: 32px; border: 1px solid #ccc; border-radius: 4px;" />
                                </div>
                            </FluentStack>
                            
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                                <FluentCheckbox @bind-Value="newPosition.IsFlexPosition" Label="Flex Position" />
                                <FluentLabel Style="color: #666; font-size: 0.9em;">(accepts any school type)</FluentLabel>
                            </FluentStack>
                            
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                                <FluentButton Appearance="Appearance.Accent" 
                                              OnClick="@AddRosterPosition"
                                              Disabled="@(IsAddPositionDisabled())"
                                              Loading="isAddingPosition">
                                    Add Position
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    </div>
                </FluentCard>
                
                <!-- Current Positions List -->
                @if (rosterPositions.Any())
                {
                    <FluentCard Style="margin-bottom: 24px;">
                        <div style="padding: 20px;">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                                <FluentLabel Weight="FontWeight.Bold">Current Roster Configuration</FluentLabel>
                                
                                <div style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                                    @foreach (var position in rosterPositions.OrderBy(p => p.DisplayOrder))
                                    {
                                        <div style="@($"padding: 16px; border-bottom: 1px solid #eee; background-color: {position.ColorCode}20;")"
                                             @key="position.RosterPositionId">
                                            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="16">
                                                <div style="@($"width: 24px; height: 24px; background-color: {position.ColorCode}; border-radius: 4px; border: 1px solid #ccc;")"></div>
                                                <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
                                                    <FluentLabel Weight="FontWeight.Bold" Style="font-size: 16px;">@position.PositionName</FluentLabel>
                                                    <FluentLabel Style="font-size: 14px; color: #666;">
                                                        @position.SlotsPerTeam slot@(position.SlotsPerTeam != 1 ? "s" : "") per team
                                                        @if (position.IsFlexPosition) { <text> â€¢ Flex Position</text> }
                                                    </FluentLabel>
                                                </FluentStack>
                                                
                                                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                                                    <FluentButton Appearance="Appearance.Neutral" 
                                                                  IconStart="@(new Icons.Regular.Size16.ArrowUp())"
                                                                  OnClick="@(() => MovePositionUp(position))"
                                                                  Disabled="@(rosterPositions.OrderBy(p => p.DisplayOrder).First() == position)"
                                                                  Title="Move up" />
                                                    <FluentButton Appearance="Appearance.Neutral" 
                                                                  IconStart="@(new Icons.Regular.Size16.ArrowDown())"
                                                                  OnClick="@(() => MovePositionDown(position))"
                                                                  Disabled="@(rosterPositions.OrderBy(p => p.DisplayOrder).Last() == position)"
                                                                  Title="Move down" />
                                                    <FluentButton Appearance="Appearance.Neutral" 
                                                                  IconStart="@(new Icons.Regular.Size16.Delete())"
                                                                  OnClick="@(() => RemoveRosterPosition(position))"
                                                                  Loading="@(deletingPositionId == position.RosterPositionId)"
                                                                  Title="Delete" />
                                                </FluentStack>
                                            </FluentStack>
                                        </div>
                                    }
                                </div>
                                
                                <!-- Roster Summary -->
                                <FluentCard Style="background-color: #e3f2fd; border: 1px solid #2196f3;">
                                    <div style="padding: 16px;">
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                            <FluentLabel Weight="FontWeight.Bold" Style="color: #1976d2;">Team Composition Summary</FluentLabel>
                                            <FluentLabel Style="color: #1976d2;">
                                                Each team will have <strong>@rosterPositions.Sum(p => p.SlotsPerTeam) schools</strong> total
                                                (@rosterPositions.Count(p => !p.IsFlexPosition) specific position@(rosterPositions.Count(p => !p.IsFlexPosition) != 1 ? "s" : ""), 
                                                 @rosterPositions.Where(p => p.IsFlexPosition).Sum(p => p.SlotsPerTeam) flex slot@(rosterPositions.Where(p => p.IsFlexPosition).Sum(p => p.SlotsPerTeam) != 1 ? "s" : ""))
                                            </FluentLabel>
                                        </FluentStack>
                                    </div>
                                </FluentCard>
                            </FluentStack>
                        </div>
                    </FluentCard>
                }
                else
                {
                    <FluentCard Style="padding: 32px; text-align: center;">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16" HorizontalAlignment="HorizontalAlignment.Center">
                            <FluentIcon Value="@(new Icons.Regular.Size48.Settings())" 
                                        Style="color: #666; width: 64px; height: 64px;" />
                            <FluentLabel Style="color: #666;">No roster positions configured yet. Add positions above to define your team structure.</FluentLabel>
                        </FluentStack>
                    </FluentCard>
                }

                <!-- Continue Button -->
                @if (rosterPositions.Any())
                {
                    <div style="text-align: center; padding-top: 24px;">
                        <FluentButton Appearance="Appearance.Accent" 
                                      OnClick="@CompleteRosterConfig"
                                      IconEnd="@(new Icons.Regular.Size16.ArrowRight())">
                            Continue to Review
                        </FluentButton>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int AuctionId { get; set; }
    [Parameter] public AuctionDto? Auction { get; set; }
    [Parameter] public EventCallback OnCompleted { get; set; }

    private bool isLoading = true;
    private bool isAddingPosition = false;
    private int? deletingPositionId = null;
    private List<RosterPositionDto> rosterPositions = new();
    private List<string> availablePositions = new();
    private NewRosterPosition newPosition = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRosterPositions();
        await LoadAvailablePositions();
        ResetNewPosition(); // Initialize with default position after loading available positions
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadRosterPositions()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Remove("X-Management-Token");
            Http.DefaultRequestHeaders.Add("X-Management-Token", token);

            var response = await Http.GetAsync($"/api/management/auctions/{AuctionId}/roster-positions");
            if (response.IsSuccessStatusCode)
            {
                var positions = await response.Content.ReadFromJsonAsync<List<RosterPositionDto>>();
                rosterPositions = positions ?? new List<RosterPositionDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading roster positions: {ex.Message}");
        }
    }

    private async Task LoadAvailablePositions()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Remove("X-Management-Token");
            Http.DefaultRequestHeaders.Add("X-Management-Token", token);

            var response = await Http.GetAsync($"/api/management/auctions/{AuctionId}/available-positions");
            if (response.IsSuccessStatusCode)
            {
                var positions = await response.Content.ReadFromJsonAsync<List<string>>();
                availablePositions = positions ?? new List<string>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading available positions: {ex.Message}");
        }
    }

    private async Task AddRosterPosition()
    {
        var actualPositionName = newPosition.PositionName == "Custom" 
            ? newPosition.CustomPositionName.Trim() 
            : newPosition.PositionName.Trim();
            
        if (string.IsNullOrWhiteSpace(actualPositionName) || newPosition.SlotsPerTeam <= 0) return;
        
        try
        {
            isAddingPosition = true;
            StateHasChanged();

            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Remove("X-Management-Token");
            Http.DefaultRequestHeaders.Add("X-Management-Token", token);

            var finalPositionName = newPosition.PositionName == "Custom" 
                ? newPosition.CustomPositionName.Trim() 
                : newPosition.PositionName.Trim();

            var request = new CreateRosterPositionRequest
            {
                AuctionId = AuctionId,
                PositionName = finalPositionName,
                SlotsPerTeam = newPosition.SlotsPerTeam,
                ColorCode = newPosition.ColorCode,
                IsFlexPosition = newPosition.IsFlexPosition,
                DisplayOrder = rosterPositions.Count + 1
            };

            var response = await Http.PostAsJsonAsync("/api/management/roster-positions", request);
            if (response.IsSuccessStatusCode)
            {
                await LoadRosterPositions();
                ResetNewPosition();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Error adding roster position: {error}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error adding roster position: {ex.Message}");
        }
        finally
        {
            isAddingPosition = false;
            StateHasChanged();
        }
    }

    private async Task RemoveRosterPosition(RosterPositionDto position)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the '{position.PositionName}' position?");
        if (!confirmed) return;

        try
        {
            deletingPositionId = position.RosterPositionId;
            StateHasChanged();

            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Remove("X-Management-Token");
            Http.DefaultRequestHeaders.Add("X-Management-Token", token);

            var response = await Http.DeleteAsync($"/api/management/roster-positions/{position.RosterPositionId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadRosterPositions();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Error removing roster position: {error}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error removing roster position: {ex.Message}");
        }
        finally
        {
            deletingPositionId = null;
            StateHasChanged();
        }
    }

    private async Task MovePositionUp(RosterPositionDto position)
    {
        await ReorderPosition(position, -1);
    }

    private async Task MovePositionDown(RosterPositionDto position)
    {
        await ReorderPosition(position, 1);
    }

    private async Task ReorderPosition(RosterPositionDto position, int direction)
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Remove("X-Management-Token");
            Http.DefaultRequestHeaders.Add("X-Management-Token", token);

            var request = new ReorderPositionRequest
            {
                RosterPositionId = position.RosterPositionId,
                Direction = direction
            };

            var response = await Http.PostAsJsonAsync($"/api/management/roster-positions/{position.RosterPositionId}/reorder", request);
            if (response.IsSuccessStatusCode)
            {
                await LoadRosterPositions();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error reordering positions: {ex.Message}");
        }
    }

    private void ResetNewPosition()
    {
        // Set default position name to first available option or "Flex" if none available
        var defaultPositionName = availablePositions.Any() ? availablePositions.First() : "Flex";
        
        newPosition = new NewRosterPosition
        {
            PositionName = defaultPositionName,
            ColorCode = "#0078d4",
            SlotsPerTeam = 1
        };
    }

    private List<string> GetPositionOptions()
    {
        var options = new List<string>();
        options.AddRange(availablePositions);
        
        if (!options.Contains("Flex"))
            options.Add("Flex");
            
        options.Add("Custom");
        
        return options;
    }

    private bool IsAddPositionDisabled()
    {
        if (newPosition.SlotsPerTeam <= 0) return true;
        if (string.IsNullOrWhiteSpace(newPosition.PositionName)) return true;
        if (newPosition.PositionName == "Custom" && string.IsNullOrWhiteSpace(newPosition.CustomPositionName))
            return true;
        return false;
    }

    private async Task CompleteRosterConfig()
    {
        await OnCompleted.InvokeAsync();
    }

    // DTOs
    public class RosterPositionDto
    {
        public int RosterPositionId { get; set; }
        public int AuctionId { get; set; }
        public string PositionName { get; set; } = string.Empty;
        public int SlotsPerTeam { get; set; }
        public string ColorCode { get; set; } = string.Empty;
        public int DisplayOrder { get; set; }
        public bool IsFlexPosition { get; set; }
    }

    public class NewRosterPosition
    {
        public string PositionName { get; set; } = string.Empty;
        public string CustomPositionName { get; set; } = string.Empty;
        public int SlotsPerTeam { get; set; } = 1;
        public string ColorCode { get; set; } = "#0078d4";
        public bool IsFlexPosition { get; set; } = false;
    }

    public class CreateRosterPositionRequest
    {
        public int AuctionId { get; set; }
        public string PositionName { get; set; } = string.Empty;
        public int SlotsPerTeam { get; set; }
        public string ColorCode { get; set; } = string.Empty;
        public int DisplayOrder { get; set; }
        public bool IsFlexPosition { get; set; }
    }

    public class ReorderPositionRequest
    {
        public int RosterPositionId { get; set; }
        public int Direction { get; set; }
    }

}

<style>
    .roster-config-step {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .step-header {
        padding: 24px 24px 16px 24px;
        border-bottom: 1px solid #e1e1e1;
        background: #f8f9fa;
    }

    .step-body {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
    }

    .roster-config-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .loading-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
        gap: 16px;
    }
</style>