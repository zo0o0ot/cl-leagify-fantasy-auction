@using System.Net.Http.Json
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="bidding-panel">
    <!-- Current Bidding State -->
    @if (isActiveBidding)
    {
        <FluentCard class="current-bidding-card">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                <FluentLabel Typo="Typography.Subject" Style="color: #0078d4;">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Clock())" Style="vertical-align: middle;" />
                    Bidding In Progress
                </FluentLabel>

                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Typo="Typography.Header" Style="font-size: 24px;">
                        @currentSchoolName
                    </FluentLabel>

                    @if (!string.IsNullOrEmpty(currentSchoolConference))
                    {
                        <FluentLabel Style="color: #666;">@currentSchoolConference</FluentLabel>
                    }
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="24" Wrap="true">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <FluentLabel Style="font-weight: 600; color: #666;">Current High Bid</FluentLabel>
                        <FluentLabel Typo="Typography.Header" Style="color: #28a745; font-size: 28px;">
                            $@currentHighBid?.ToString("N0")
                        </FluentLabel>
                    </FluentStack>

                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <FluentLabel Style="font-weight: 600; color: #666;">High Bidder</FluentLabel>
                        <FluentLabel Style="font-size: 18px;">@currentHighBidderDisplayName</FluentLabel>
                    </FluentStack>

                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <FluentLabel Style="font-weight: 600; color: #666;">Nominated By</FluentLabel>
                        <FluentLabel Style="font-size: 18px;">@nominatedByDisplayName</FluentLabel>
                    </FluentStack>
                </FluentStack>

                <!-- Bidding Controls -->
                <FluentDivider Style="margin: 8px 0;" />

                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12" VerticalAlignment="VerticalAlignment.Bottom">
                    <div style="flex: 1; max-width: 200px;">
                        <FluentNumberField @bind-Value="bidAmount"
                                           Label="Your Bid"
                                           Min="1"
                                           Step="1"
                                           Placeholder="Enter amount"
                                           Style="width: 100%;" />
                    </div>

                    <FluentButton Appearance="Appearance.Accent"
                                  IconStart="@(new Icons.Regular.Size20.Money())"
                                  OnClick="PlaceBid"
                                  Disabled="@(isBidding || bidAmount <= currentHighBid)"
                                  Loading="@isBidding">
                        Place Bid
                    </FluentButton>

                    <FluentButton Appearance="Appearance.Neutral"
                                  IconStart="@(new Icons.Regular.Size20.DismissCircle())"
                                  OnClick="PassOnSchool"
                                  Disabled="@isPassing"
                                  Loading="@isPassing">
                        Pass
                    </FluentButton>
                </FluentStack>

                @if (userHasHighBid)
                {
                    <FluentMessageBar Intent="MessageIntent.Success">
                        You have the current high bid! Wait for other participants to pass or bid higher.
                    </FluentMessageBar>
                }
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <!-- Waiting for Nomination -->
        <FluentCard class="waiting-card">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                @if (isYourTurn)
                {
                    <FluentLabel Typo="Typography.Subject" Style="color: #0078d4;">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Star())" Style="vertical-align: middle;" />
                        It's Your Turn to Nominate!
                    </FluentLabel>

                    <FluentLabel Style="margin-bottom: 12px;">
                        Select a school from the available schools list below to start bidding.
                    </FluentLabel>

                    <!-- School selection will be handled by parent component or separate school list -->
                    <FluentButton Appearance="Appearance.Accent"
                                  IconStart="@(new Icons.Regular.Size20.Add())"
                                  OnClick="@(() => OnRequestNomination.InvokeAsync())"
                                  Style="align-self: flex-start;">
                        Nominate a School
                    </FluentButton>
                }
                else
                {
                    <FluentLabel Typo="Typography.Subject">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Clock())" Style="vertical-align: middle;" />
                        Waiting for Nomination
                    </FluentLabel>

                    @if (!string.IsNullOrEmpty(currentNominatorDisplayName))
                    {
                        <FluentLabel Style="font-size: 18px;">
                            <strong>@currentNominatorDisplayName</strong>'s turn to nominate
                        </FluentLabel>
                    }
                    else
                    {
                        <FluentLabel Style="color: #666;">
                            Waiting for the auction to begin...
                        </FluentLabel>
                    }

                    <FluentProgressRing Style="width: 40px; height: 40px; margin-top: 16px;" />
                }
            </FluentStack>
        </FluentCard>
    }

    <!-- Recent Activity Feed -->
    @if (recentActivity.Any())
    {
        <FluentCard Style="margin-top: 16px;">
            <FluentLabel Typo="Typography.Subject" Style="margin-bottom: 12px;">
                Recent Activity
            </FluentLabel>

            <div class="activity-feed">
                @foreach (var activity in recentActivity.Take(10))
                {
                    <div class="activity-item" @key="activity.Id">
                        <FluentLabel Style="color: #666; font-size: 12px;">
                            @activity.Timestamp.ToString("h:mm:ss tt")
                        </FluentLabel>
                        <FluentLabel Style="margin-left: 8px;">
                            @activity.Message
                        </FluentLabel>
                    </div>
                }
            </div>
        </FluentCard>
    }
</div>

@code {
    [Parameter] public int AuctionId { get; set; }
    [Parameter] public int UserId { get; set; }
    [Parameter] public EventCallback OnRequestNomination { get; set; }

    // Current bidding state
    private bool isActiveBidding = false;
    private int? currentSchoolId;
    private string? currentSchoolName;
    private string? currentSchoolConference;
    private decimal? currentHighBid;
    private int? currentHighBidderUserId;
    private string? currentHighBidderDisplayName;
    private string? nominatedByDisplayName;

    // Nomination state
    private int? currentNominatorUserId;
    private string? currentNominatorDisplayName;
    private bool isYourTurn => currentNominatorUserId == UserId && !isActiveBidding;
    private bool userHasHighBid => currentHighBidderUserId == UserId;

    // UI state
    private decimal bidAmount = 0;
    private bool isBidding = false;
    private bool isPassing = false;

    // Activity feed
    private List<ActivityItem> recentActivity = new();

    // SignalR connection
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadBiddingState();
        await InitializeSignalR();
    }

    private async Task LoadBiddingState()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "auctionToken");
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            Http.DefaultRequestHeaders.Remove("X-Auction-Token");
            Http.DefaultRequestHeaders.Add("X-Auction-Token", token);

            var response = await Http.GetAsync($"/api/auction/{AuctionId}/bidding-state");
            if (response.IsSuccessStatusCode)
            {
                var state = await response.Content.ReadFromJsonAsync<BiddingStateDto>();
                if (state != null)
                {
                    UpdateBiddingState(state);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bidding state: {ex.Message}");
        }
    }

    private void UpdateBiddingState(BiddingStateDto state)
    {
        isActiveBidding = state.IsActiveBidding;
        currentSchoolId = state.CurrentSchoolId;
        currentSchoolName = state.CurrentSchoolName;
        currentHighBid = state.CurrentHighBid;
        currentHighBidderUserId = state.CurrentHighBidderUserId;
        currentHighBidderDisplayName = state.CurrentHighBidderDisplayName;
        currentNominatorUserId = state.CurrentNominatorUserId;
        currentNominatorDisplayName = state.CurrentNominatorDisplayName;

        // Set initial bid amount to one more than current high bid
        if (currentHighBid.HasValue)
        {
            bidAmount = currentHighBid.Value + 1;
        }

        StateHasChanged();
    }

    private async Task InitializeSignalR()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "auctionToken");
            if (string.IsNullOrEmpty(token))
            {
                return;
            }

            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri($"/api?token={token}"))
                .WithAutomaticReconnect()
                .Build();

            // Subscribe to bidding events
            hubConnection.On<BiddingStartedEvent>("BiddingStarted", (evt) =>
            {
                currentSchoolId = evt.AuctionSchoolId;
                currentSchoolName = evt.SchoolName;
                currentSchoolConference = evt.Conference;
                currentHighBid = evt.CurrentHighBid;
                currentHighBidderUserId = evt.CurrentHighBidderUserId;
                currentHighBidderDisplayName = evt.CurrentHighBidderDisplayName;
                nominatedByDisplayName = evt.NominatedByDisplayName;
                isActiveBidding = true;
                bidAmount = currentHighBid.Value + 1;

                AddActivity($"{evt.NominatedByDisplayName} nominated {evt.SchoolName} for ${evt.CurrentHighBid}");
                StateHasChanged();
            });

            hubConnection.On<BidPlacedEvent>("BidPlaced", (evt) =>
            {
                currentHighBid = evt.BidAmount;
                currentHighBidderUserId = evt.BidderUserId;
                currentHighBidderDisplayName = evt.BidderDisplayName;
                bidAmount = currentHighBid.Value + 1;

                AddActivity($"{evt.BidderDisplayName} bid ${evt.BidAmount} on {evt.SchoolName}");
                StateHasChanged();
            });

            hubConnection.On<UserPassedEvent>("UserPassed", (evt) =>
            {
                AddActivity($"{evt.DisplayName} passed on {evt.SchoolName}");
                StateHasChanged();
            });

            hubConnection.On<BiddingCompletedEvent>("BiddingCompleted", (evt) =>
            {
                isActiveBidding = false;
                currentSchoolId = null;
                currentSchoolName = null;
                currentHighBid = null;
                currentHighBidderUserId = null;
                currentHighBidderDisplayName = null;

                AddActivity($"{evt.WinnerDisplayName} won {evt.SchoolName} for ${evt.WinningBid}");
                StateHasChanged();
            });

            hubConnection.On<NominationTurnChangedEvent>("NominationTurnChanged", (evt) =>
            {
                currentNominatorUserId = evt.CurrentNominatorUserId;
                currentNominatorDisplayName = evt.CurrentNominatorDisplayName;

                if (evt.CurrentNominatorUserId == UserId)
                {
                    AddActivity("It's your turn to nominate!");
                }
                else
                {
                    AddActivity($"{evt.CurrentNominatorDisplayName}'s turn to nominate");
                }
                StateHasChanged();
            });

            await hubConnection.StartAsync();
            Console.WriteLine("SignalR connection established");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing SignalR: {ex.Message}");
        }
    }

    private async Task PlaceBid()
    {
        if (bidAmount <= currentHighBid || isBidding) return;

        try
        {
            isBidding = true;
            StateHasChanged();

            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "auctionToken");
            if (string.IsNullOrEmpty(token))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Authentication required");
                return;
            }

            Http.DefaultRequestHeaders.Remove("X-Auction-Token");
            Http.DefaultRequestHeaders.Add("X-Auction-Token", token);

            var request = new { BidAmount = bidAmount };
            var response = await Http.PostAsJsonAsync($"/api/auction/{AuctionId}/bid", request);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to place bid: {error}");
            }
            // Success will be handled by SignalR event
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error placing bid: {ex.Message}");
        }
        finally
        {
            isBidding = false;
            StateHasChanged();
        }
    }

    private async Task PassOnSchool()
    {
        if (isPassing) return;

        try
        {
            isPassing = true;
            StateHasChanged();

            var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "auctionToken");
            if (string.IsNullOrEmpty(token))
            {
                await JSRuntime.InvokeVoidAsync("alert", "Authentication required");
                return;
            }

            Http.DefaultRequestHeaders.Remove("X-Auction-Token");
            Http.DefaultRequestHeaders.Add("X-Auction-Token", token);

            var response = await Http.PostAsync($"/api/auction/{AuctionId}/pass", null);

            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to pass: {error}");
            }
            // Success will be handled by SignalR event
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error passing: {ex.Message}");
        }
        finally
        {
            isPassing = false;
            StateHasChanged();
        }
    }

    private void AddActivity(string message)
    {
        recentActivity.Insert(0, new ActivityItem
        {
            Id = Guid.NewGuid(),
            Message = message,
            Timestamp = DateTime.Now
        });

        // Keep only last 50 items
        if (recentActivity.Count > 50)
        {
            recentActivity = recentActivity.Take(50).ToList();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    // DTOs

    private class BiddingStateDto
    {
        public int AuctionId { get; set; }
        public string Status { get; set; } = "";
        public int? CurrentNominatorUserId { get; set; }
        public string? CurrentNominatorDisplayName { get; set; }
        public int? CurrentSchoolId { get; set; }
        public string? CurrentSchoolName { get; set; }
        public decimal? CurrentHighBid { get; set; }
        public int? CurrentHighBidderUserId { get; set; }
        public string? CurrentHighBidderDisplayName { get; set; }
        public bool IsActiveBidding { get; set; }
    }

    private class BiddingStartedEvent
    {
        public int AuctionSchoolId { get; set; }
        public string SchoolName { get; set; } = "";
        public string? Conference { get; set; }
        public int NominatedByUserId { get; set; }
        public string NominatedByDisplayName { get; set; } = "";
        public decimal CurrentHighBid { get; set; }
        public int CurrentHighBidderUserId { get; set; }
        public string CurrentHighBidderDisplayName { get; set; } = "";
        public decimal ProjectedPoints { get; set; }
    }

    private class BidPlacedEvent
    {
        public int AuctionSchoolId { get; set; }
        public string SchoolName { get; set; } = "";
        public decimal BidAmount { get; set; }
        public int BidderUserId { get; set; }
        public string BidderDisplayName { get; set; } = "";
        public decimal CurrentHighBid { get; set; }
        public int CurrentHighBidderUserId { get; set; }
        public string CurrentHighBidderDisplayName { get; set; } = "";
    }

    private class UserPassedEvent
    {
        public int UserId { get; set; }
        public string DisplayName { get; set; } = "";
        public string SchoolName { get; set; } = "";
    }

    private class BiddingCompletedEvent
    {
        public int DraftPickId { get; set; }
        public string SchoolName { get; set; } = "";
        public decimal WinningBid { get; set; }
        public int WinnerUserId { get; set; }
        public string WinnerDisplayName { get; set; } = "";
        public int TeamId { get; set; }
        public string TeamName { get; set; } = "";
    }

    private class NominationTurnChangedEvent
    {
        public int? CurrentNominatorUserId { get; set; }
        public string? CurrentNominatorDisplayName { get; set; }
    }

    private class ActivityItem
    {
        public Guid Id { get; set; }
        public string Message { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}

<style>
    .bidding-panel {
        width: 100%;
        max-width: 800px;
    }

    .current-bidding-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
        border: 2px solid #0078d4;
        box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2);
    }

    .waiting-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        text-align: center;
        padding: 32px 24px;
    }

    .activity-feed {
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .activity-item {
        display: flex;
        align-items: baseline;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #0078d4;
    }

    .activity-item:nth-child(even) {
        background: #ffffff;
    }

    /* Mobile responsive */
    @@media (max-width: 600px) {
        .bidding-panel {
            max-width: 100%;
        }

        .current-bidding-card fluent-stack[orientation="Horizontal"] {
            flex-direction: column;
        }
    }
</style>
