@page "/management/login"
@layout EmptyLayout
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<FluentStack Style="min-height: 100vh; align-items: center; justify-content: center; background: var(--neutral-layer-1);">
    <FluentCard Style="width: 400px; padding: 32px;">
        <FluentStack Style="gap: 24px; text-align: center;">
            <FluentStack Style="gap: 8px;">
                <FluentIcon Value="@(new Icons.Regular.Size32.Shield())" Color="Color.Accent" />
                <FluentLabel Typo="Typography.PageTitle">Management Access</FluentLabel>
                <FluentLabel Typo="Typography.Body">
                    Enter the master password to access the management interface.
                </FluentLabel>
            </FluentStack>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <FluentMessageBar Intent="MessageIntent.Error">
                    @errorMessage
                </FluentMessageBar>
            }

            @if (isLoading)
            {
                <FluentStack Style="gap: 16px; align-items: center;">
                    <FluentProgressRing />
                    <FluentLabel>Authenticating...</FluentLabel>
                </FluentStack>
            }
            else
            {
                <EditForm Model="@loginModel" OnValidSubmit="@LoginAsync">
                    <FluentStack Style="gap: 16px;">
                        <FluentTextField @bind-Value="loginModel.Password" 
                                       Label="Master Password" 
                                       Type="TextFieldType.Password"
                                       Required="true"
                                       Style="width: 100%;"
                                       @onkeypress="@OnKeyPress" />
                        
                        <FluentButton Type="ButtonType.Submit" 
                                     Appearance="Appearance.Accent" 
                                     Style="width: 100%;">
                            Sign In
                        </FluentButton>
                    </FluentStack>
                </EditForm>
            }

            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">
                This is a secure management area. Only authorized personnel should access this interface.
            </FluentLabel>
        </FluentStack>
    </FluentCard>
</FluentStack>


@code {
    private LoginModel loginModel = new();
    private bool isLoading;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // Check if already logged in
        var token = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "managementToken");
        if (!string.IsNullOrEmpty(token))
        {
            // Validate existing token
            try
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
                var response = await Http.GetAsync("/api/management/auth/validate");
                
                if (response.IsSuccessStatusCode)
                {
                    // Valid token, redirect to dashboard
                    Navigation.NavigateTo("/management/schools");
                    return;
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    // Expected response for invalid/expired token - just clear it
                    await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "managementToken");
                    Http.DefaultRequestHeaders.Authorization = null;
                }
            }
            catch (Exception ex)
            {
                // Network error or other issue - clear token and continue to login form
                Console.WriteLine($"Token validation error: {ex.Message}");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "managementToken");
                Http.DefaultRequestHeaders.Authorization = null;
            }
        }
    }

    private async Task LoginAsync()
    {
        if (isLoading) return;
        
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("/api/management/auth/login", loginModel);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AuthResponse>();
                if (result?.Success == true && !string.IsNullOrEmpty(result.Token))
                {
                    // Store token in localStorage
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "managementToken", result.Token);
                    
                    // Set authorization header for future requests
                    Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", result.Token);
                    
                    // Navigate to management dashboard
                    Navigation.NavigateTo("/management/schools");
                    return;
                }
            }
            
            // Login failed
            var errorContent = await response.Content.ReadAsStringAsync();
            errorMessage = response.StatusCode == System.Net.HttpStatusCode.Unauthorized ? 
                "Invalid password. Please try again." : 
                $"Login failed: {errorContent}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await LoginAsync();
        }
    }

    public class LoginModel
    {
        public string Password { get; set; } = "";
    }

    public class AuthResponse
    {
        public bool Success { get; set; }
        public string? Token { get; set; }
        public string? Message { get; set; }
        public DateTime? ExpiresAt { get; set; }
    }
}