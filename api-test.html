<!DOCTYPE html>
<html>
<head>
    <title>API Test Harness</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 8px 16px; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { overflow-x: auto; }
        input { margin: 5px; padding: 4px; }
    </style>
</head>
<body>
    <h1>Leagify API Test Harness</h1>
    
    <div class="section">
        <h3>Step 1: Join Auction</h3>
        <label>Join Code: <input type="text" id="joinCode" value="DEMO" placeholder="Enter join code"></label><br>
        <label>Display Name: <input type="text" id="displayName" value="TestUser" placeholder="Enter display name"></label><br>
        <button onclick="joinAuction()">Join Auction</button>
        <div id="joinOutput" class="output"></div>
    </div>
    
    <div class="section">
        <h3>Step 2: Get Participants</h3>
        <label>Auction ID: <input type="number" id="auctionId" value="1" placeholder="Enter auction ID"></label><br>
        <button onclick="getParticipants()">Get Participants</button>
        <div id="participantsOutput" class="output"></div>
    </div>
    
    <div class="section">
        <h3>Step 3: Leave Auction</h3>
        <label>Session Token: <input type="text" id="sessionToken" placeholder="Session token from join response"></label><br>
        <button onclick="leaveAuction()">Leave Auction</button>
        <div id="leaveOutput" class="output"></div>
    </div>
    
    <div class="section">
        <h3>Step 4: Check Participants After Leave</h3>
        <button onclick="getParticipantsAfterLeave()">Get Participants (After Leave)</button>
        <div id="participantsAfterOutput" class="output"></div>
    </div>

    <div class="section" style="border-color: #dc3545; background-color: #fff5f5;">
        <h3 style="color: #dc3545;">ðŸ§¹ Cleanup Tools</h3>
        <p><strong>Warning:</strong> These tools permanently delete data. Use for testing only!</p>

        <h4>Option 1: Reset Auction (Keep auction, remove participants/teams)</h4>
        <label>Auction ID: <input type="number" id="resetAuctionId" value="37" placeholder="Enter auction ID"></label><br>
        <button onclick="resetAuction()" style="background-color: #ffc107; color: black;">Reset Auction</button>
        <div id="resetOutput" class="output"></div>

        <h4>Option 2: Delete Entire Auction</h4>
        <label>Auction ID: <input type="number" id="deleteAuctionId" value="37" placeholder="Enter auction ID"></label><br>
        <button onclick="deleteAuction()" style="background-color: #dc3545; color: white;">Delete Entire Auction</button>
        <div id="deleteOutput" class="output"></div>

        <h4>Option 3: Bulk Cleanup Test Auctions</h4>
        <p>Deletes all auctions with "test", "debug", "sample", or "demo" in their names</p>
        <button onclick="cleanupTestAuctions()" style="background-color: #dc3545; color: white;">Cleanup All Test Auctions</button>
        <div id="cleanupOutput" class="output"></div>

        <h4>Check Current Auctions</h4>
        <button onclick="getAuctions()">List All Auctions</button>
        <div id="auctionsOutput" class="output"></div>
    </div>

    <script>
        const API_BASE = 'https://jolly-meadow-0b4450210.2.azurestaticapps.net/api';
        let currentAuctionId = null;
        let currentSessionToken = null;

        async function joinAuction() {
            const joinCode = document.getElementById('joinCode').value;
            const displayName = document.getElementById('displayName').value;
            const output = document.getElementById('joinOutput');
            
            try {
                const response = await fetch(`${API_BASE}/auction/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ joinCode, displayName })
                });
                
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;
                
                if (response.ok) {
                    const data = JSON.parse(result);
                    currentAuctionId = data.auctionId;
                    currentSessionToken = data.sessionToken;
                    document.getElementById('auctionId').value = currentAuctionId;
                    document.getElementById('sessionToken').value = currentSessionToken;
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function getParticipants() {
            const auctionId = document.getElementById('auctionId').value || currentAuctionId;
            const output = document.getElementById('participantsOutput');
            
            try {
                const response = await fetch(`${API_BASE}/auction/${auctionId}/participants`);
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;
                
                if (response.ok) {
                    const data = JSON.parse(result);
                    // Display structured info
                    let summary = `<strong>Participants Summary:</strong><br>`;
                    data.forEach(p => {
                        summary += `â€¢ ${p.displayName}: ${p.isConnected ? 'Online' : 'Offline'}`;
                        if (p.roles && p.roles.length > 0) {
                            const teamRoles = p.roles.filter(r => r.teamName);
                            if (teamRoles.length > 0) {
                                summary += ` | Teams: ${teamRoles.map(r => r.teamName).join(', ')}`;
                            }
                            summary += ` | Roles: ${p.roles.map(r => r.role).join(', ')}`;
                        }
                        summary += `<br>`;
                    });
                    output.innerHTML += `<br>${summary}`;
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function leaveAuction() {
            const auctionId = document.getElementById('auctionId').value || currentAuctionId;
            const sessionToken = document.getElementById('sessionToken').value || currentSessionToken;
            const output = document.getElementById('leaveOutput');
            
            try {
                const response = await fetch(`${API_BASE}/auction/${auctionId}/leave`, {
                    method: 'POST',
                    headers: { 'X-Auction-Token': sessionToken }
                });
                
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function getParticipantsAfterLeave() {
            const auctionId = document.getElementById('auctionId').value || currentAuctionId;
            const output = document.getElementById('participantsAfterOutput');
            
            try {
                const response = await fetch(`${API_BASE}/auction/${auctionId}/participants`);
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;
                
                if (response.ok) {
                    const data = JSON.parse(result);
                    // Display structured info
                    let summary = `<strong>Participants After Leave:</strong><br>`;
                    data.forEach(p => {
                        summary += `â€¢ ${p.displayName}: ${p.isConnected ? 'Online' : 'Offline'}`;
                        if (p.roles && p.roles.length > 0) {
                            const teamRoles = p.roles.filter(r => r.teamName);
                            if (teamRoles.length > 0) {
                                summary += ` | Teams: ${teamRoles.map(r => r.teamName).join(', ')}`;
                            }
                            summary += ` | Roles: ${p.roles.map(r => r.role).join(', ')}`;
                        }
                        summary += `<br>`;
                    });
                    output.innerHTML += `<br>${summary}`;
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        // Cleanup functions
        async function getAuctions() {
            const output = document.getElementById('auctionsOutput');

            try {
                const response = await fetch(`${API_BASE}/diagnostic/auctions`);
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function resetAuction() {
            const auctionId = document.getElementById('resetAuctionId').value;
            const output = document.getElementById('resetOutput');

            if (!auctionId) {
                output.innerHTML = '<strong>Error:</strong> Please enter an auction ID';
                return;
            }

            if (!confirm(`Are you sure you want to RESET auction ${auctionId}? This will delete all participants, teams, and roles but keep the auction.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/diagnostic/auction/${auctionId}/reset`, {
                    method: 'POST'
                });
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;

                if (response.ok) {
                    output.innerHTML += '<br><strong style="color: green;">âœ“ Auction reset successfully! All participants, teams, and roles removed.</strong>';
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function deleteAuction() {
            const auctionId = document.getElementById('deleteAuctionId').value;
            const output = document.getElementById('deleteOutput');

            if (!auctionId) {
                output.innerHTML = '<strong>Error:</strong> Please enter an auction ID';
                return;
            }

            if (!confirm(`Are you sure you want to PERMANENTLY DELETE auction ${auctionId}? This cannot be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/diagnostic/auction/${auctionId}`, {
                    method: 'DELETE'
                });
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;

                if (response.ok) {
                    output.innerHTML += '<br><strong style="color: green;">âœ“ Auction permanently deleted!</strong>';
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function cleanupTestAuctions() {
            const output = document.getElementById('cleanupOutput');

            if (!confirm('Are you sure you want to DELETE ALL TEST AUCTIONS? This will permanently delete all auctions with "test", "debug", "sample", or "demo" in their names!')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/diagnostic/cleanup-test-auctions`, {
                    method: 'POST'
                });
                const result = await response.text();
                output.innerHTML = `<strong>Status:</strong> ${response.status}<br><pre>${result}</pre>`;

                if (response.ok) {
                    const data = JSON.parse(result);
                    output.innerHTML += `<br><strong style="color: green;">âœ“ Cleanup completed! Deleted ${data.TotalTestAuctions} test auctions</strong>`;
                }
            } catch (error) {
                output.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }
    </script>
</body>
</html>